@page "/Book-Flight"
@rendermode InteractiveServer
@using flight_booking.Core
@inject MPISModel Model
@inject MPISController Controller
@implements IDisposable

<h3>Book Flight</h3>
<p><strong>Current state: </strong> @Model.State</p>

@if (Model.State == MpisState.FlightEnquiry)
{
    <!-- Flight list + back button-->
    <div class="mb-3">
        <button class="btn btn-secondary" @onclick="() => Controller.Back()">Back</button>
    </div>

    <h5>Select a flight</h5>
    <table class="table">
        <thead>
            <tr>
                <th>Number</th>
                <th>From → To</th>
                <th>Departure</th>
                <th>Seats</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in Model.Flights)
            {
                <tr>
                    <td>@f.Number</td>
                    <td>@f.From → @f.To</td>
                    <td>@f.DepartureUtc.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@f.SeatsAvailable</td>
                    <td><button class="btn btn-primary" @onclick="() => SelectFlight(f.Id)">Select</button></td>
                </tr>
            }
        </tbody>
    </table>
}
else if (Model.State == MpisState.SeatEnquiry)
{
    <!-- Seat selection with buttons. Taken seats are disabled. Clicking seat moves to reservation-->
    <div class="mb-3" style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <button class="btn btn-secondary" @onclick="() => Controller.Back()">Back</button>
    </div>

<h5>Choose your seat</h5>
<p>
    <em>Flight: </em>
    @Model.SelectedFlight?.Number (@Model.SelectedFlight?.From → @Model.SelectedFlight?.To)
</p>

 <div style="display:flex; flex-direction:column; gap:.5rem; max-width:340px;">
        @for (int row = 1; row <= 3; row++)
        {
            <div style="display:flex; gap:.5rem;">
                @foreach (var col in new[] { 'A', 'B', 'C', 'D' })
                {
                    var seat = $"{row}{col}";
                    bool taken = Model.IsSeatTaken(seat);

                    <button class="btn @(taken ? "btn-outline-secondary" : "btn-primary")"
                            disabled="@(taken)"
                            title="@(taken ? "Seat is taken" : "Select seat")"
                            style="min-width:64px;"
                            @onclick="() => PickSeat(seat)">
                        @seat
                    </button>
                }
            </div>
        }
    </div>

    <p class="text-muted" style="margin-top:.75rem;">
        Seats in grey are already taken
    </p>
}
else if (Model.State == MpisState.Reservation)
{
    <!-- Review and confirm -->
    <div class="mb-3" style="display:flex; gap: .5rem; flex-wrap:wrap;">
        <button class="btn btn-secondary" @onclick="() => Controller.Back()">Back</button>
        <button class="btn btn-success" @onclick="() => Controller.Confirm()">Confirm</button>
    </div>

    <h5>Review</h5>
    <ul>
        <li><strong>Flight:</strong> @Model.SelectedFlight?.Number (@Model.SelectedFlight?.From → @Model.SelectedFlight?.To)</li>
        <li><strong>Seat:</strong> @Model.SelectedSeat</li>
    </ul>
}
else if (Model.State ==MpisState.Confirmation)
{
    <div class="alert alert-success">
        <strong>Confirmation</strong> @Model.ConfirmationCode
    </div>
    <button class="btn btn-secondary" @onclick="() => Controller.Back()">Back</button>
    <button class="btn btn-primary" @onclick="() => Controller.Finish()">Finish</button>
}
else
{
    <!-- Initial state -->
    <button class="btn btn-primary" @onclick="Controller.Start">Start</button>
}

@code
{
    protected override void OnInitialized()
    {
        //Subscribe to model changees so the page re-renders when data/state changes
        Model.Changed += OnChanged;
    }

    private void OnChanged() => InvokeAsync(StateHasChanged);

    private void SelectFlight(string id)
    {
        var ok = Controller.PickFlight(id);
        if (!ok)
        {
            Console.WriteLine("Failed to pick flight.");
        }
    }

    private void PickSeat(string seat)
    {
        var ok = Controller.PickSeat(seat);
        if (!ok)
        {
            Console.WriteLine("Failed tp pick seat (maybe taken or wrong state).");
        }
    }

    public void Dispose()
    {
        //Unsubscribe to avoid memory leaks on disconnect
        Model.Changed -= OnChanged;
    }
}